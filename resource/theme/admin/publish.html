{{define "admin/publish"}}
{{template "admin/header" .}}

<div class="admin-card">
    <div class="admin-card-header">
        {{.Tr.T "publish_article"}}
    </div>
    <div class="admin-card-body">
        <input type="hidden" id="inputID" value="{{.Data.article.ID}}">
        
        <div class="form-group">
            <label for="inputTitle" class="form-label">{{.Tr.T "title"}}</label>
            <input class="form-control" id="inputTitle" placeholder="Title" value="{{.Data.article.Title}}">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="inputSlug" class="form-label">{{.Tr.T "slug"}}</label>
                <input class="form-control" id="inputSlug" placeholder="URL slug" value="{{.Data.article.Slug}}">
            </div>

            <div class="form-group">
                <label for="inputTags" class="form-label">{{.Tr.T "labels"}}</label>
                <input class="form-control" id="inputTags" placeholder="dev,golang,docker" value="{{.Data.article.RawTags}}">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="selTemplate" class="form-label">Template</label>
                <select id="selTemplate" class="form-control">
                    {{range $k,$v := .Data.templates}}
                    <option value="{{$k}}" {{if eq $.Data.article.TemplateID $k}} selected{{end}}>{{$v}}</option>
                    {{end}}
                </select>
            </div>

            <div class="form-group">
                <label for="inputCID" class="form-label">{{.Tr.T "book_refer"}}</label>
                <input class="form-control" id="inputCID" value="{{if .Data.article.BookRefer}}{{.Data.article.BookRefer}}{{end}}">
            </div>
        </div>

        <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
            <div class="form-check">
                <input{{if .Data.article.IsBook}} checked{{end}} id="cbBook" type="checkbox">
                <label for="cbBook">{{.Tr.T "its_a_book"}}</label>
            </div>
            <div class="form-check">
                <input{{if .Data.article.IsPrivate}} checked{{end}} id="cbPrivate" type="checkbox">
                <label for="cbPrivate">Private</label>
            </div>
            <div class="form-check">
                <input id="cbNewVersion" type="checkbox">
                <label for="cbNewVersion">{{.Tr.T "new_version"}}</label>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Content</label>
            <div id="editSection"></div>
        </div>

        <button onclick="publish(this)" class="btn btn-primary btn-lg">
            <i class="fa fa-paper-plane"></i> {{.Tr.T "publish"}}
        </button>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.10.5/index.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.10.5/index.min.js" crossorigin="anonymous"></script>
<script>
    window.onbeforeunload = function (e) { var e = e || window.event; if (e) { e.returnValue = '请确保编辑内容已妥善保存'; } return '请确保编辑内容已妥善保存'; };
    const vditor = new Vditor('editSection', {
        after() {
            vditor.setValue('{{.Data.article.Content}}')
        },
        upload: {
            accept: 'image/*,.mp4,.rar,.zip,.wav,.mp3',
            url: '/admin/upload',
            linkToImgUrl: '/admin/fetch',
        },
    })
    function publish(btn) {
        if ($(btn).hasClass("disabled")) {
            return
        }
        $(btn).toggleClass("disabled")
        var article = {
            id: $("#inputID").val(),
            title: $("#inputTitle").val(),
            slug: $("#inputSlug").val(),
            content: vditor.getValue(),
            template: parseInt($("#selTemplate").val()),
            tags: $("#inputTags").val(),
            is_book: document.getElementById('cbBook').checked,
            is_private: document.getElementById('cbPrivate').checked,
            new_version: document.getElementById('cbNewVersion').checked ? 1 : 0,
        }
        $("#inputCID").val() && (article.book_refer = $("#inputCID").val())
        $.post("", article, (data, status) => {
            window.location.href = "/" + article.slug
        }).fail((err) => {
            alert("Publish failed: " + err.responseText)
        }).always(() => {
            $(btn).toggleClass("disabled")
        })
    }
</script>

{{template "admin/footer" .}}
{{end}}