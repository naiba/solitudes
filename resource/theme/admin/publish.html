{{define "admin/publish"}}
{{template "admin/header" .}}

<div class="admin-container">
    <div class="page-header">
        <h1 class="page-title">{{.Tr.T "publish_article"}}</h1>
        <p class="page-subtitle">Focus on your writing</p>
    </div>

    <div class="editor-container">
        <input type="hidden" id="inputID" value="{{.Data.article.ID}}">
        
        <!-- Title Input - Large and Prominent -->
        <input 
            class="editor-title-input w-full" 
            id="inputTitle" 
            placeholder="Article Title" 
            value="{{.Data.article.Title}}"
            autocomplete="off">
        
        <!-- Metadata Section -->
        <details class="mb-6 border border-gray-200 rounded-lg" open>
            <summary class="px-4 py-3 bg-gray-50 font-medium text-gray-700 rounded-t-lg cursor-pointer select-none list-none">
                <i class="fa fa-cog mr-2"></i>
                Article Settings
                <i class="fa fa-chevron-down float-right mt-1"></i>
            </summary>

            <div class="p-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="inputSlug" class="block text-sm font-medium text-gray-700 mb-1">
                            {{.Tr.T "slug"}} (URL)
                        </label>
                        <input 
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500" 
                            id="inputSlug" 
                            placeholder="my-article-slug" 
                            value="{{.Data.article.Slug}}"
                            autocomplete="off">
                        <p class="text-xs text-gray-500 mt-1">Lowercase, hyphens only</p>
                </div>

                <div>
                    <label for="inputTags" class="block text-sm font-medium text-gray-700 mb-1">
                        {{.Tr.T "labels"}}
                    </label>
                    <input 
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500" 
                        id="inputTags" 
                        placeholder="dev,golang,docker" 
                        value="{{.Data.article.RawTags}}"
                        autocomplete="off">
                    <p class="text-xs text-gray-500 mt-1">Comma-separated tags</p>
                </div>
            </div>

            <!-- Topic Instructions -->
            <div class="help-block help-block-info">
                <div class="flex items-start gap-2">
                    <i class="fa fa-lightbulb-o text-blue-600 mt-1"></i>
                    <div class="flex-1">
                        <strong class="text-sm">Topic (哔哔) Publishing Tip:</strong>
                        <p class="text-sm mt-1">
                            For topics/moments, use the tag <span class="topic-badge">Topic</span> (case-sensitive).
                        </p>
                        <p class="text-sm mt-1">
                            <strong>Auto-generation rules:</strong>
                        </p>
                        <ul class="text-sm mt-1 ml-4" style="list-style: disc;">
                            <li>If slug is empty → auto-generates timestamp <code class="bg-gray-100 px-2 py-0.5 rounded text-xs">20241225103045</code></li>
                            <li>If title is also empty → uses the auto-generated slug as title</li>
                        </ul>
                        <p class="text-sm mt-2">
                            Example: Leave both empty with Topic tag → slug and title become <code class="bg-gray-100 px-2 py-0.5 rounded text-xs">20241225103045</code>
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="selTemplate" class="block text-sm font-medium text-gray-700 mb-1">Template</label>
                    <select id="selTemplate" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                        {{range $k,$v := .Data.templates}}
                        <option value="{{$k}}" {{if eq $.Data.article.TemplateID $k}} selected{{end}}>{{$v}}</option>
                        {{end}}
                    </select>
                </div>

                <div>
                    <label for="inputCID" class="block text-sm font-medium text-gray-700 mb-1">
                        {{.Tr.T "book_refer"}} (UUID)
                    </label>
                    <input 
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500" 
                        id="inputCID" 
                        placeholder="Book/Series UUID"
                        value="{{if .Data.article.BookRefer}}{{.Data.article.BookRefer}}{{end}}"
                        autocomplete="off">
                </div>
            </div>

            <div class="flex flex-wrap gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input{{if .Data.article.IsBook}} checked{{end}} id="cbBook" type="checkbox" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">{{.Tr.T "its_a_book"}}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input{{if .Data.article.IsPrivate}} checked{{end}} id="cbPrivate" type="checkbox" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">Private</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input id="cbNewVersion" type="checkbox" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">{{.Tr.T "new_version"}}</span>
                </label>
            </div>
            </div>
        </details>

        <!-- Editor -->
        <div id="editSection" style="min-height: 400px;"></div>

        <!-- Publish Button -->
        <div class="mt-6 flex justify-end">
            <button 
                onclick="publish(this)" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="fa fa-paper-plane mr-2"></i>{{.Tr.T "publish"}}
            </button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.10.5/index.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.10.5/index.min.js" crossorigin="anonymous"></script>
<script>
    window.onbeforeunload = function (e) { var e = e || window.event; if (e) { e.returnValue = '请确保编辑内容已妥善保存'; } return '请确保编辑内容已妥善保存'; };
    const vditor = new Vditor('editSection', {
        after() {
            vditor.setValue('{{.Data.article.Content}}')
        },
        upload: {
            accept: 'image/*,.mp4,.rar,.zip,.wav,.mp3',
            url: '/admin/upload',
            linkToImgUrl: '/admin/fetch',
        },
        height: 500,
    })
    
    function publish(btn) {
        if ($(btn).hasClass("disabled")) {
            return
        }
        $(btn).toggleClass("disabled")
        var article = {
            id: $("#inputID").val(),
            title: $("#inputTitle").val(),
            slug: $("#inputSlug").val(),
            content: vditor.getValue(),
            template: parseInt($("#selTemplate").val()),
            tags: $("#inputTags").val(),
            is_book: document.getElementById('cbBook').checked,
            is_private: document.getElementById('cbPrivate').checked,
            new_version: document.getElementById('cbNewVersion').checked ? 1 : 0,
        }
        $("#inputCID").val() && (article.book_refer = $("#inputCID").val())
        $.post("", article, (data, status) => {
            window.location.href = "/" + article.slug
        }).fail((err) => {
            alert("Publish failed: " + err.responseText)
        }).always(() => {
            $(btn).toggleClass("disabled")
        })
    }
</script>

{{template "admin/footer" .}}
{{end}}