{{define "admin/publish"}}
{{template "admin/header" .}}

<div class="admin-container">
    <div class="page-header">
        <h1 class="page-title">{{.Tr.T "publish_article"}}</h1>
        <p class="page-subtitle">{{.Tr.T "publish_subtitle"}}</p>
    </div>

    <div class="editor-container">
        <input type="hidden" id="inputID" value="{{.Data.article.ID}}">
        
        <!-- Title Input - Large and Prominent -->
        <input 
            class="editor-title-input w-full" 
            id="inputTitle" 
            placeholder="{{.Tr.T "article_title_placeholder"}}" 
            value="{{.Data.article.Title}}"
            autocomplete="off">
        
        <!-- Metadata Section -->
        <details class="mb-6 border border-gray-200 rounded-lg" open>
            <summary class="px-4 py-3 bg-gray-50 font-medium text-gray-700 rounded-t-lg cursor-pointer select-none list-none">
                <i class="fa-solid fa-gear mr-2"></i>
                {{.Tr.T "article_settings"}}
                <i class="fa-solid fa-chevron-down float-right mt-1"></i>
            </summary>

            <div class="p-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="inputSlug" class="block text-sm font-medium text-gray-700 mb-1">
                            {{.Tr.T "slug"}} (URL)
                        </label>
                        <input 
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500" 
                            id="inputSlug" 
                            placeholder="my-article-slug" 
                            value="{{.Data.article.Slug}}"
                            autocomplete="off">
                        <p class="text-xs text-gray-500 mt-1">{{.Tr.T "lowercase_hyphens_only"}}</p>
                </div>

                <div>
                    <label for="inputTags" class="block text-sm font-medium text-gray-700 mb-1">
                        {{.Tr.T "labels"}}
                    </label>
                    <div class="relative">
                        <input 
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500" 
                            id="inputTags" 
                            placeholder="Dev,Golang,Docker" 
                            value="{{.Data.article.RawTags}}"
                            autocomplete="off">
                        <div id="tagsDropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-b shadow-lg hidden max-h-48 overflow-y-auto"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">{{.Tr.T "comma_separated_tags"}}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="selTemplate" class="block text-sm font-medium text-gray-700 mb-1">{{.Tr.T "template"}}</label>
                    <select id="selTemplate" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                        {{range $k,$v := .Data.templates}}
                        <option value="{{$k}}" {{if eq $.Data.article.TemplateID $k}} selected{{end}}>{{$v}}</option>
                        {{end}}
                    </select>
                </div>

                <div>
                    <label for="inputCID" class="block text-sm font-medium text-gray-700 mb-1">
                        {{.Tr.T "book_refer"}}
                    </label>
                    <div class="relative">
                        <input 
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500" 
                            id="inputCID" 
                            placeholder="{{.Tr.T "book_refer_placeholder"}}"
                            value="{{if .Data.article.BookRefer}}{{.Data.article.BookRefer}}{{end}}"
                            autocomplete="off">
                        <div id="booksDropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-b shadow-lg hidden max-h-48 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input{{if .Data.article.IsBook}} checked{{end}} id="cbBook" type="checkbox" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">{{.Tr.T "its_a_book"}}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input{{if .Data.article.IsPrivate}} checked{{end}} id="cbPrivate" type="checkbox" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">{{.Tr.T "private"}}</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input id="cbNewVersion" type="checkbox" class="rounded border-gray-300">
                    <span class="text-sm text-gray-700">{{.Tr.T "new_version"}}</span>
                </label>
            </div>
            </div>
        </details>

        <!-- Editor -->
        <div id="editSection" style="min-height: 400px;"></div>

        <!-- Publish Button -->
        <div class="mt-6 flex justify-end">
            <button 
                onclick="publish(this)" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="fa-solid fa-paper-plane mr-2"></i>{{.Tr.T "publish"}}
            </button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.2/index.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.2/index.min.js" crossorigin="anonymous"></script>
<script>
    window.onbeforeunload = function (e) { var e = e || window.event; if (e) { e.returnValue = '{{.Tr.T "ensure_content_saved"}}'; } return '{{.Tr.T "ensure_content_saved"}}'; };
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const vditor = new Vditor('editSection', {
        theme: isDarkMode ? 'dark' : 'classic',
        after() {
            vditor.setValue('{{.Data.article.Content}}')
        },
        upload: {
            accept: 'image/*,.mp4,.rar,.zip,.wav,.mp3',
            url: '/admin/upload',
            linkToImgUrl: '/admin/fetch',
        },
        height: 500,
    })
    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        vditor.setTheme(e.matches ? 'dark' : 'classic');
    });
    
    function publish(btn) {
        if ($(btn).hasClass("disabled")) {
            return
        }
        $(btn).toggleClass("disabled")
        var article = {
            id: $("#inputID").val(),
            title: $("#inputTitle").val(),
            slug: $("#inputSlug").val(),
            content: vditor.getValue(),
            template: parseInt($("#selTemplate").val()),
            tags: $("#inputTags").val(),
            is_book: document.getElementById('cbBook').checked,
            is_private: document.getElementById('cbPrivate').checked,
            new_version: document.getElementById('cbNewVersion').checked ? 1 : 0,
        }
        $("#inputCID").val() && (article.book_refer = $("#inputCID").val())
        $.post("", article, (data, status) => {
            window.location.href = "/" + article.slug
        }).fail((err) => {
            alert('{{.Tr.T "publish_failed"}} ' + err.responseText)
        }).always(() => {
            $(btn).toggleClass("disabled")
        })
    }

    // Tags search functionality
    (function() {
        const tagsInput = document.getElementById('inputTags');
        const tagsDropdown = document.getElementById('tagsDropdown');
        let searchTimeout = null;

        tagsInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const value = this.value;
            const lastComma = value.lastIndexOf(',');
            const searchTerm = lastComma >= 0 ? value.substring(lastComma + 1).trim() : value.trim();
            
            if (searchTerm.length < 1) {
                tagsDropdown.classList.add('hidden');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch('/admin/api/search-tags?q=' + encodeURIComponent(searchTerm))
                    .then(r => r.json())
                    .then(tags => {
                        if (tags && tags.length > 0) {
                            tagsDropdown.innerHTML = tags.map(tag => 
                                `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm" data-tag="${tag}">${tag}</div>`
                            ).join('');
                            tagsDropdown.classList.remove('hidden');
                        } else {
                            tagsDropdown.classList.add('hidden');
                        }
                    });
            }, 200);
        });

        tagsDropdown.addEventListener('click', function(e) {
            const tagEl = e.target.closest('[data-tag]');
            if (tagEl) {
                const tag = tagEl.dataset.tag;
                const value = tagsInput.value;
                const lastComma = value.lastIndexOf(',');
                if (lastComma >= 0) {
                    tagsInput.value = value.substring(0, lastComma + 1) + tag + ',';
                } else {
                    tagsInput.value = tag + ',';
                }
                tagsDropdown.classList.add('hidden');
                tagsInput.focus();
            }
        });

        document.addEventListener('click', function(e) {
            if (!tagsInput.contains(e.target) && !tagsDropdown.contains(e.target)) {
                tagsDropdown.classList.add('hidden');
            }
        });
    })();

    // Books search functionality
    (function() {
        const booksInput = document.getElementById('inputCID');
        const booksDropdown = document.getElementById('booksDropdown');
        let searchTimeout = null;

        booksInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.trim();
            
            if (searchTerm.length < 1) {
                booksDropdown.classList.add('hidden');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch('/admin/api/search-books?q=' + encodeURIComponent(searchTerm))
                    .then(r => r.json())
                    .then(books => {
                        if (books && books.length > 0) {
                            booksDropdown.innerHTML = books.map(book => 
                                `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm" data-id="${book.id}">
                                    <span class="font-medium">${book.title}</span>
                                    <span class="text-gray-500 text-xs ml-2">${book.slug}</span>
                                </div>`
                            ).join('');
                            booksDropdown.classList.remove('hidden');
                        } else {
                            booksDropdown.classList.add('hidden');
                        }
                    });
            }, 200);
        });

        booksDropdown.addEventListener('click', function(e) {
            const bookEl = e.target.closest('[data-id]');
            if (bookEl) {
                booksInput.value = bookEl.dataset.id;
                booksDropdown.classList.add('hidden');
            }
        });

        document.addEventListener('click', function(e) {
            if (!booksInput.contains(e.target) && !booksDropdown.contains(e.target)) {
                booksDropdown.classList.add('hidden');
            }
        });
    })();
</script>

{{template "admin/footer" .}}
{{end}}