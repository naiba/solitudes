{{define "admin/index"}}
{{template "admin/header" .}}

<div class="admin-container">
    <div class="page-header">
        <h1 class="page-title">{{.Tr.T "dashboard"}}</h1>
        <p class="page-subtitle">{{.Tr.T "dashboard_subtitle"}}</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h2 class="stat-value">{{.Data.articleNum}}</h2>
            <p class="stat-label">{{.Tr.T "articles"}}</p>
        </div>
        <div class="stat-card">
            <h2 class="stat-value">{{.Data.lastArticlePublish}}</h2>
            <p class="stat-label">{{.Tr.T "days_left_from_the_last_post"}}</p>
        </div>
        <div class="stat-card">
            <h2 class="stat-value">{{.Data.commentNum}}</h2>
            <p class="stat-label">{{.Tr.T "comments"}}</p>
        </div>
        <div class="stat-card">
            <h2 class="stat-value">{{.Data.lastComment}}</h2>
            <p class="stat-label">{{.Tr.T "days_left_from_the_last_comment"}}</p>
        </div>
        <div class="stat-card">
            <h2 class="stat-value">{{.Data.rssSubscriberCount}}</h2>
            <p class="stat-label">{{.Tr.T "rss_subscribers"}}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="wf-card md:col-span-2">
            <div class="wf-card-header">
                {{.Tr.T "quick_topic_publish"}}
            </div>
            <div class="wf-card-body">
                <div class="flex flex-col gap-2">
                    <div id="topicContent"></div>
                    <button onclick="publishTopic(this)" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition self-end">
                        <i class="fa-solid fa-paper-plane mr-2"></i>{{.Tr.T "publish_now"}}
                    </button>
                </div>
            </div>
        </div>
        <div class="wf-card">
            <div class="wf-card-header">
                {{.Tr.T "system_stats"}}
            </div>
            <div class="wf-card-body">
                <div class="space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">{{.Tr.T "labels"}}</span>
                        <span class="font-semibold text-gray-900">{{.Data.tagNum}}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">{{.Tr.T "memory_usage"}}</span>
                        <span class="font-semibold text-gray-900">{{.Data.memoryUsage}}M</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                        <span class="text-gray-600">{{.Tr.T "gc_num"}}</span>
                        <span class="font-semibold text-gray-900">{{.Data.gcNum}}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600">{{.Tr.T "routine_num"}}</span>
                        <span class="font-semibold text-gray-900">{{.Data.routineNum}}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="wf-card">
            <div class="wf-card-header">
                {{.Tr.T "quick_actions"}}
            </div>
            <div class="wf-card-body space-y-3">
                <a href="/admin/publish" class="block w-full px-4 py-3 text-center bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                    <i class="fa-solid fa-plus mr-2"></i>{{.Tr.T "compose"}}
                </a>
                <button onclick="rebuildFullTextSearch()" class="block w-full px-4 py-3 text-center bg-red-600 text-white rounded hover:bg-red-700 transition">
                    <i class="fa-solid fa-rotate mr-2"></i>{{.Tr.T "rebuild_fulltext_search_data"}}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function rebuildFullTextSearch() {
        if (confirm('{{.Tr.T "confirm_rebuild_search"}}')) {
            ajaxRequest({
                url: "/admin/rebuild-full-text-search",
                type: 'GET',
                success: () => {
                    alert('{{.Tr.T "rebuild_successful"}}')
                }
            })
        }
    }

    function publishTopic(btn) {
        if ($(btn).hasClass("disabled")) return;
        const content = vditor.getValue().trim();
        if (!content) return;
        
        $(btn).addClass("disabled");
        const article = {
            content: content,
            tags: "Topic",
            title: "",
            slug: "",
            template: 1,
            is_book: false,
            is_private: false,
            new_version: 0
        };
        
        $.post("/admin/publish", article, (data) => {
             alert('{{.Tr.T "publish_success"}}');
             if (data && data.Slug) {
                 window.location.href = "/" + data.Slug;
             } else {
                 window.location.reload();
             }
        }).fail((err) => {
            alert('{{.Tr.T "publish_failed"}} ' + err.responseText);
        }).always(() => {
            $(btn).removeClass("disabled");
        });
    }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.2/index.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/vditor/3.11.2/index.min.js" crossorigin="anonymous"></script>
<script>
    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const vditor = new Vditor('topicContent', {
        theme: isDarkMode ? 'dark' : 'classic',
        height: 200,
        placeholder: '{{.Tr.T "topic_content_placeholder"}}',
        toolbarConfig: {
            pin: true,
        },
        cache: {
            enable: false,
        },
        upload: {
            accept: 'image/*,.mp4,.rar,.zip,.wav,.mp3',
            url: '/admin/upload',
            linkToImgUrl: '/admin/fetch',
        },
    })
    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        vditor.setTheme(e.matches ? 'dark' : 'classic');
    });
</script>

{{template "admin/footer" .}}
{{end}}